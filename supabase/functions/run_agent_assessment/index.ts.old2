import { corsHeaders } from './functions/_shared/cors.ts';
import { authenticateRequest } from './lib/auth.ts';
import { fetchAndValidateAgent, isAgentActive } from './lib/agent.ts';
import {
  fetchOpenPositions,
  fetchClosedTrades,
  fetchMarketData,
  createMarketSnapshot,
} from './lib/data.ts';
import { calculatePnLMetrics } from './lib/pnl.ts';
import { determinePromptType, generateAssessment } from './lib/llm.ts';
import { saveAssessment, savePnLSnapshot } from './lib/persistence.ts';
import { executeTrade } from './lib/trade.ts';
import { createSupabaseServiceClient } from './functions/_shared/supabase.ts';

console.log('Run Agent Assessment function started.');

/**
 * Main orchestration function for agent assessment workflow
 */
async function runAgentAssessment(agentId: string, authHeader: string) {
  // 1. Authenticate the request
  const authContext = await authenticateRequest(authHeader);

  // 2. Fetch and validate agent
  const agent = await fetchAndValidateAgent(agentId, authContext);

  // 3. Fetch all required data in parallel
  const [openPositions, closedTrades, { marketData, candleData }] = await Promise.all([
    fetchOpenPositions(agentId),
    fetchClosedTrades(agentId),
    fetchMarketData(),
  ]);

  // 4. Calculate PnL metrics (pure function)
  const initialCapital = parseFloat(String(agent.initial_capital || 0));
  const pnlMetrics = calculatePnLMetrics(initialCapital, closedTrades, openPositions, marketData);

  // 5. Determine prompt type and create context
  const promptType = determinePromptType(openPositions);
  console.log('Prompt type:', promptType);

  const promptContext = {
    promptType,
    marketData,
    openPositions,
    accountValue: pnlMetrics.accountValue,
    remainingCash: pnlMetrics.remainingCash,
    candleData,
  };

  // 6. Generate LLM assessment
  const serviceClient = createSupabaseServiceClient();
  const { response: llmResponse, prompt } = await generateAssessment(
    serviceClient,
    agent,
    promptContext
  );

  // 7. Create market snapshot
  const marketSnapshot = createMarketSnapshot(marketData, openPositions);

  // 8. Save assessment to database
  const assessment = await saveAssessment(
    agentId,
    promptType,
    marketSnapshot,
    prompt,
    llmResponse
  );

  // 9. Save PnL snapshot (non-blocking on error)
  try {
    await savePnLSnapshot(agentId, pnlMetrics, openPositions.length, assessment.id);
  } catch (error) {
    console.error('PnL snapshot error (non-fatal):', error);
  }

  // 11. Execute trade if action is required
  const tradeResult = await executeTrade(
    agentId,
    llmResponse.action,
    agent.hyperliquid_address
  );

  // 12. Return success response
  return {
    success: true,
    assessment_id: assessment.id,
    action_taken: llmResponse.action,
    trade_result: tradeResult,
    agent_name: agent.name,
    type: promptType,
  };
}

/**
 * HTTP handler for the Deno edge function
 */
Deno.serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    // Parse request body
    const { agent_id } = await req.json();
    if (!agent_id) {
      throw new Error('agent_id is required');
    }

    console.log('Running assessment for agent:', agent_id);

    // Get auth header
    const authHeader = req.headers.get('Authorization') || '';

    // Run the assessment workflow
    const result = await runAgentAssessment(agent_id, authHeader);

    // Return success response
    return new Response(JSON.stringify(result), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    });
  } catch (error) {
    console.error('Error in run_agent_assessment:', error);

    // Determine status code based on error message
    const status = error.message?.includes('Unauthorized') ? 401
      : error.message?.includes('not found') ? 404
      : 500;

    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status,
      }
    );
  }
});
